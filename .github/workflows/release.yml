name: Release TinyDb to NuGet

on:
  push:
    branches: [ main, main ]
  workflow_dispatch:

jobs:
  check-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 2  # è·å–æœ€è¿‘2ä¸ªæäº¤æ¥æ¯”è¾ƒç‰ˆæœ¬

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'

    - name: Get previous version
      id: get_previous_version
      run: |
        # è·å–ä¸Šä¸€ä¸ªæäº¤çš„ç‰ˆæœ¬å·
        if git rev-parse HEAD~1 >/dev/null 2>&1; then
          PREVIOUS_VERSION=$(git show HEAD~1:TinyDb/TinyDb.csproj | grep '<Version>' | sed 's/.*<Version>\(.*\)<\/Version>.*/\1/' | xargs)
        else
          PREVIOUS_VERSION="0.0.0"
        fi
        echo "Previous version: $PREVIOUS_VERSION"
        echo "previous_version=$PREVIOUS_VERSION" >> $GITHUB_ENV

    - name: Get current version
      id: get_current_version
      run: |
        # è·å–å½“å‰æäº¤çš„ç‰ˆæœ¬å·
        CURRENT_VERSION=$(git show HEAD:TinyDb/TinyDb.csproj | grep '<Version>' | sed 's/.*<Version>\(.*\)<\/Version>.*/\1/' | xargs)
        echo "Current version: $CURRENT_VERSION"
        echo "current_version=$CURRENT_VERSION" >> $GITHUB_ENV

    - name: Check if version changed
      id: check_version
      run: |
        if [ "$CURRENT_VERSION" != "$PREVIOUS_VERSION" ]; then
          echo "Version changed from $PREVIOUS_VERSION to $CURRENT_VERSION"
          echo "version_changed=true" >> $GITHUB_ENV
          echo "new_version=$CURRENT_VERSION" >> $GITHUB_ENV
        else
          echo "Version unchanged: $CURRENT_VERSION"
          echo "version_changed=false" >> $GITHUB_ENV
        fi

    - name: Build and test
      if: env.version_changed == 'true'
      run: |
        echo "Building TinyDb with version $CURRENT_VERSION..."

        # æ„å»ºæ•´ä¸ªè§£å†³æ–¹æ¡ˆ
        dotnet build TinyDb.sln -c Release

        # è¿è¡Œæµ‹è¯•ï¼ˆå¯é€‰ï¼Œä½†æ¨èï¼‰
        echo "Running tests..."
        dotnet test TinyDb.Tests/TinyDb.Tests.csproj -c Release --no-build --logger "console;verbosity=minimal"

        # æ„å»º NuGet åŒ…
        echo "Building NuGet package..."
        dotnet pack TinyDb/TinyDb.csproj -c Release --no-build --output ./nupkg

        # éªŒè¯åŒ…å†…å®¹
        echo "Verifying package contents..."
        NUPKG_FILE=$(find ./nupkg -name "TinyDb.$CURRENT_VERSION.nupkg" | head -1)
        if [ -n "$NUPKG_FILE" ]; then
          echo "âœ… Package found: $NUPKG_FILE"

          # æ£€æŸ¥åŒ…å†…å®¹
          TEMP_DIR=$(mktemp -d)
          unzip -q "$NUPKG_FILE" -d "$TEMP_DIR"

          echo "ğŸ“‹ Package contents:"
          [ -f "$TEMP_DIR/lib/net8.0/TinyDb.dll" ] && echo "  âœ… .NET 8.0 library"
          [ -f "$TEMP_DIR/lib/net9.0/TinyDb.dll" ] && echo "  âœ… .NET 9.0 library"
          [ -f "$TEMP_DIR/analyzers/dotnet/cs/TinyDb.SourceGenerator.dll" ] && echo "  âœ… SourceGenerator analyzer"
          [ -f "$TEMP_DIR/content/aot-compatibility.json" ] && echo "  âœ… AOT compatibility config"
          [ -f "$TEMP_DIR/content/aot-example.csproj" ] && echo "  âœ… AOT example config"

          rm -rf "$TEMP_DIR"
        else
          echo "âŒ Package not found!"
          exit 1
        fi

    - name: Create Git Tag
      if: env.version_changed == 'true'
      run: |
        echo "Creating Git tag v$CURRENT_VERSION..."
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git tag -a "v$CURRENT_VERSION" -m "Release version $CURRENT_VERSION"

    - name: Push Git Tag
      if: env.version_changed == 'true'
      run: |
        echo "Pushing Git tag..."
        git push origin "v$CURRENT_VERSION"

    - name: Setup NuGet
      if: env.version_changed == 'true'
      run: |
        echo "Setting up NuGet..."
        dotnet nuget add source --name "github" --username "github-actions" --password "${{ secrets.GITHUB_TOKEN }}" --store-password-in-clear-text

    - name: Publish to NuGet
      if: env.version_changed == 'true'
      run: |
        echo "Publishing to NuGet..."
        dotnet nuget push ./nupkg/TinyDb.$CURRENT_VERSION.nupkg --source "github" --skip-duplicate --no-symbols

        # æ¸…ç†
        rm -rf ./nupkg

    - name: Create Release
      if: env.version_changed == 'true'
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ env.CURRENT_VERSION }}
        release_name: TinyDb v${{ env.CURRENT_VERSION }}
        body: |
          ## ğŸš€ TinyDb v${{ env.CURRENT_VERSION }

          ### ğŸ“¦ åŒ…ä¿¡æ¯
          - **ç‰ˆæœ¬:** v${{ env.CURRENT_VERSION }}
          - **æ¡†æ¶:** .NET 8.0 + .NET 9.0
          - **ç±»å‹:** NuGet åŒ…

          ### âœ¨ ä¸»è¦ç‰¹æ€§
          - ğŸ¯ **è½»é‡çº§ NoSQL æ•°æ®åº“** - å•æ–‡ä»¶åµŒå…¥å¼æ•°æ®åº“
          - âš¡ **AOT å…¼å®¹** - æ”¯æŒåŸç”Ÿç¼–è¯‘ï¼Œæ€§èƒ½ä¼˜å¼‚
          - ğŸ”§ **SourceGenerator** - è‡ªåŠ¨ç”Ÿæˆå…ƒæ•°æ®å’Œä¼˜åŒ–ä»£ç 
          - ğŸ”’ **å®‰å…¨æ”¯æŒ** - å†…ç½®å¯†ç ä¿æŠ¤å’ŒåŠ å¯†
          - ğŸ“Š **å®Œæ•´ API** - CRUDã€æŸ¥è¯¢ã€ç´¢å¼•ã€äº‹åŠ¡

          ### ğŸ› ï¸ æŠ€æœ¯è§„æ ¼
          - **ç›®æ ‡æ¡†æ¶:** net8.0, net9.0
          - **AOT å…¼å®¹:** âœ…
          **SourceGenerator:** âœ…
          **åŒ…å¤§å°:** ~300KB

          ### ğŸ“‹ å®‰è£…ä½¿ç”¨
          ```bash
          dotnet add package TinyDb --version ${{ env.CURRENT_VERSION }
          ```

          ### ğŸ”— ç›¸å…³é“¾æ¥
          - ğŸ“– [æ–‡æ¡£](https://github.com/j4587698/TinyDb)
          - ğŸ“¦ [NuGet åŒ…](https://www.nuget.org/packages/TinyDb)
          - ğŸ› [GitHub ä»“åº“](https://github.com/j4587698/TinyDb)

          ---
          ğŸ¤– è‡ªåŠ¨å‘å¸ƒäº $(date +'%Y-%m-%d %H:%M:%S')
        draft: false
        prerelease: false