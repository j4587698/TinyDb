name: Release TinyDb to NuGet

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  check-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 2  # è·å–æœ€è¿‘2ä¸ªæäº¤æ¥æ¯”è¾ƒç‰ˆæœ¬

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: |
          8.0.x
          9.0.x
          10.0.x

    - name: Get previous version
      id: get_previous_version
      run: |
        # è·å–æœ€æ–°çš„Git tagç‰ˆæœ¬å·
        LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
        if [ -n "$LATEST_TAG" ]; then
          # ç§»é™¤ 'v' å‰ç¼€ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          PREVIOUS_VERSION=$(echo "$LATEST_TAG" | sed 's/^v//')
        else
          PREVIOUS_VERSION="0.0.0"
        fi
        echo "Latest tag: $LATEST_TAG"
        echo "Previous version: $PREVIOUS_VERSION"
        echo "previous_version=$PREVIOUS_VERSION" >> $GITHUB_ENV

    - name: Get current version
      id: get_current_version
      run: |
        # è·å–å½“å‰æäº¤çš„ç‰ˆæœ¬å·
        CURRENT_VERSION=$(git show HEAD:TinyDb/TinyDb.csproj | grep '<Version>' | sed 's/.*<Version>\(.*\)<\/Version>.*/\1/' | xargs)
        echo "Current version: $CURRENT_VERSION"
        echo "current_version=$CURRENT_VERSION" >> $GITHUB_ENV

    - name: Check if version changed
      id: check_version
      run: |
        CURRENT_VERSION="${{ env.current_version }}"
        PREVIOUS_VERSION="${{ env.previous_version }}"

        if [ "$CURRENT_VERSION" != "$PREVIOUS_VERSION" ]; then
          echo "Version changed from $PREVIOUS_VERSION to $CURRENT_VERSION"
          echo "version_changed=true" >> $GITHUB_ENV
          echo "new_version=$CURRENT_VERSION" >> $GITHUB_ENV
        else
          echo "Version unchanged: $CURRENT_VERSION"
          echo "version_changed=false" >> $GITHUB_ENV
        fi

    - name: Build and test
      if: env.version_changed == 'true'
      run: |
        echo "Building TinyDb with version ${{ env.current_version }}..."

        # æ„å»ºæ•´ä¸ªè§£å†³æ–¹æ¡ˆ
        dotnet build TinyDb.sln -c Release

        # è¿è¡Œæµ‹è¯• (TUnit æ”¯æŒ dotnet testï¼Œä¼šåŒæ—¶è¿è¡Œæ‰€æœ‰ç›®æ ‡æ¡†æ¶)
        echo "Running tests on all target frameworks (net8.0, net9.0, net10.0)..."
        dotnet test --project TinyDb.Tests/TinyDb.Tests.csproj -c Release

        # æ„å»º NuGet åŒ…
        echo "Building NuGet package..."
        dotnet pack TinyDb/TinyDb.csproj -c Release --output ./nupkg

    - name: Run AOT tests on .NET 10
      if: env.version_changed == 'true'
      run: |
        echo "Publishing AOT test binary for .NET 10..."
        dotnet publish TinyDb.Tests/TinyDb.Tests.csproj -c Release -f net10.0 -r linux-x64 --self-contained true

        echo "Running AOT tests..."
        ./TinyDb.Tests/bin/Release/net10.0/linux-x64/publish/TinyDb.Tests

    - name: Verify NuGet package
      if: env.version_changed == 'true'
      run: |
        echo "Verifying package contents..."
        NUPKG_FILE=$(find ./nupkg -name "TinyDb.${{ env.current_version }}.nupkg" | head -1)
        if [ -n "$NUPKG_FILE" ]; then
          echo "âœ… Package found: $NUPKG_FILE"

          # æ£€æŸ¥åŒ…å†…å®¹
          TEMP_DIR=$(mktemp -d)
          unzip -q "$NUPKG_FILE" -d "$TEMP_DIR"

          echo "ğŸ“‹ Package contents:"
          [ -f "$TEMP_DIR/lib/net8.0/TinyDb.dll" ] && echo "  âœ… .NET 8.0 library"
          [ -f "$TEMP_DIR/lib/net9.0/TinyDb.dll" ] && echo "  âœ… .NET 9.0 library"
          [ -f "$TEMP_DIR/lib/net10.0/TinyDb.dll" ] && echo "  âœ… .NET 10.0 library"

          if [ -f "$TEMP_DIR/analyzers/dotnet/cs/TinyDb.SourceGenerator.dll" ]; then
            echo "  âœ… SourceGenerator analyzer"
          else
            echo "  âŒ SourceGenerator analyzer MISSING!"
            echo "  ğŸ” Analyzers directory contents:"
            find "$TEMP_DIR/analyzers" -type f 2>/dev/null || echo "    No analyzers directory found"
            echo "  ğŸ” Full package structure:"
            find "$TEMP_DIR" -type f | sort
            exit 1
          fi

          [ -f "$TEMP_DIR/content/aot-compatibility.json" ] && echo "  âœ… AOT compatibility config"
          [ -f "$TEMP_DIR/content/aot-example.csproj" ] && echo "  âœ… AOT example config"

          rm -rf "$TEMP_DIR"
        else
          echo "âŒ Package not found!"
          exit 1
        fi

    - name: Create Git Tag
      if: env.version_changed == 'true'
      run: |
        echo "Creating Git tag v${{ env.current_version }}..."
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git tag -a "v${{ env.current_version }}" -m "Release version ${{ env.current_version }}"

    - name: Push Git Tag
      if: env.version_changed == 'true'
      run: |
        echo "Pushing Git tag..."
        git push origin "v${{ env.current_version }}"

    - name: Setup NuGet
      if: env.version_changed == 'true'
      run: |
        echo "Setting up NuGet..."

    - name: Publish to NuGet.org
      if: env.version_changed == 'true'
      run: |
        echo "Publishing to NuGet.org..."
        dotnet nuget push ./nupkg/TinyDb.${{ env.current_version }}.nupkg --source https://api.nuget.org/v3/index.json --api-key ${{ secrets.NUGET_API_KEY }} --skip-duplicate

    - name: Publish to GitHub Packages
      if: env.version_changed == 'true'
      run: |
        echo "Publishing to GitHub Packages..."
        dotnet nuget push ./nupkg/TinyDb.${{ env.current_version }}.nupkg --source https://nuget.pkg.github.com/j4587698/index.json --api-key ${{ secrets.GITHUB_TOKEN }} --skip-duplicate

        # æ¸…ç†
        rm -rf ./nupkg
