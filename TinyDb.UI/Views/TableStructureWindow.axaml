<suki:SukiWindow xmlns="https://github.com/avaloniaui"
            xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
            xmlns:vm="using:TinyDb.UI.ViewModels"
            xmlns:models="using:TinyDb.UI.Models"
            xmlns:suki="clr-namespace:SukiUI.Controls;assembly=SukiUI"
            xmlns:material="clr-namespace:Material.Icons.Avalonia;assembly=Material.Icons.Avalonia"
            xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
            xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
            mc:Ignorable="d" d:DesignWidth="900" d:DesignHeight="600"
            x:Class="TinyDb.UI.Views.TableStructureWindow"
            x:DataType="vm:TableStructureViewModel"
            Title="设计表 - TinyDb Professional" 
            Width="950" Height="650"
            FontFamily="Inter, Microsoft YaHei, Segoe UI"
            FontSize="14"
            WindowStartupLocation="CenterOwner">

    <Grid RowDefinitions="Auto, *, Auto" Margin="20">
        <!-- 表名栏 -->
        <suki:GlassCard Grid.Row="0" Margin="0,0,0,15" Padding="15">
            <Grid ColumnDefinitions="Auto, *, Auto">
                <TextBlock Text="表名:" VerticalAlignment="Center" Margin="0,0,15,0" FontWeight="SemiBold"/>
                <TextBox Grid.Column="1" Text="{Binding EditingTable.TableName}" Watermark="例如: Users" Theme="{DynamicResource SukiTextBoxTheme}"/>
                <StackPanel Grid.Column="2" Orientation="Horizontal" Margin="20,0,0,0" Spacing="10">
                    <Button Classes="Accent" Command="{Binding SaveTableCommand}" IsEnabled="{Binding CanSaveTable}">保存设计</Button>
                    <Button Classes="Basic" Command="{Binding CancelEditCommand}">取消</Button>
                </StackPanel>
            </Grid>
        </suki:GlassCard>

        <!-- 字段列表 (稳定版 ListBox 模拟 Grid) -->
        <Border Grid.Row="1" Background="{DynamicResource SukiBackground}" CornerRadius="8" BorderBrush="{DynamicResource SukiBorderBrush}" BorderThickness="1">
            <Grid RowDefinitions="Auto, *">
                <!-- 表头 -->
                <Border Grid.Row="0" Background="{DynamicResource SukiLightBackground}" Padding="15,10" BorderBrush="{DynamicResource SukiBorderBrush}" BorderThickness="0,0,0,1">
                    <Grid ColumnDefinitions="*, 150, 80, 80, 50">
                        <TextBlock Grid.Column="0" Text="字段名" FontWeight="Bold" Opacity="0.6"/>
                        <TextBlock Grid.Column="1" Text="数据类型" FontWeight="Bold" Opacity="0.6" Margin="10,0"/>
                        <TextBlock Grid.Column="2" Text="主键" FontWeight="Bold" Opacity="0.6" HorizontalAlignment="Center"/>
                        <TextBlock Grid.Column="3" Text="必填" FontWeight="Bold" Opacity="0.6" HorizontalAlignment="Center"/>
                        <TextBlock Grid.Column="4" Text="" />
                    </Grid>
                </Border>

                <!-- 字段项列表 -->
                <ListBox Grid.Row="1" ItemsSource="{Binding EditingTable.Fields}" 
                         SelectedItem="{Binding SelectedField}"
                         Background="Transparent" BorderThickness="0" Padding="0">
                    <ListBox.ItemTemplate>
                        <DataTemplate DataType="models:TableField">
                            <Grid ColumnDefinitions="*, 150, 80, 80, 50" Height="45">
                                <!-- 字段名编辑 -->
                                <TextBox Grid.Column="0" Text="{Binding FieldName}" VerticalAlignment="Center" BorderThickness="0" Background="Transparent"/>
                                
                                <!-- 类型选择 -->
                                <ComboBox Grid.Column="1" SelectedItem="{Binding FieldType}" Margin="10,0" VerticalAlignment="Center" HorizontalAlignment="Stretch">
                                    <models:TableFieldType>String</models:TableFieldType>
                                    <models:TableFieldType>Integer</models:TableFieldType>
                                    <models:TableFieldType>Double</models:TableFieldType>
                                    <models:TableFieldType>Boolean</models:TableFieldType>
                                    <models:TableFieldType>DateTime</models:TableFieldType>
                                </ComboBox>

                                <CheckBox Grid.Column="2" IsChecked="{Binding IsPrimaryKey}" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                <CheckBox Grid.Column="3" IsChecked="{Binding IsRequired}" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                
                                <Button Grid.Column="4" Classes="Flat" Command="{Binding $parent[Window].((vm:TableStructureViewModel)DataContext).RemoveFieldCommand}" Padding="0">
                                    <material:MaterialIcon Kind="Close" Width="16" Foreground="Red"/>
                                </Button>
                            </Grid>
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                </ListBox>
            </Grid>
        </Border>

        <StackPanel Grid.Row="1" VerticalAlignment="Bottom" HorizontalAlignment="Left" Margin="10">
             <Button Classes="Primary" Command="{Binding AddFieldCommand}">
                <StackPanel Orientation="Horizontal" Spacing="8">
                    <material:MaterialIcon Kind="PlusCircle" />
                    <TextBlock Text="新增字段"/>
                </StackPanel>
            </Button>
        </StackPanel>

        <!-- 底部状态 -->
        <TextBlock Grid.Row="2" Text="{Binding StatusMessage}" FontSize="12" Opacity="0.5" Margin="0,10,0,0"/>
    </Grid>
</suki:SukiWindow>
