<suki:SukiWindow xmlns="https://github.com/avaloniaui"
            xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
            xmlns:vm="using:TinyDb.UI.ViewModels"
            xmlns:models="using:TinyDb.UI.Models"
            xmlns:suki="clr-namespace:SukiUI.Controls;assembly=SukiUI"
            xmlns:material="clr-namespace:Material.Icons.Avalonia;assembly=Material.Icons.Avalonia"
            xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
            xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
            mc:Ignorable="d" d:DesignWidth="1200" d:DesignHeight="800"
            x:Class="TinyDb.UI.Views.MainWindow"
            x:DataType="vm:MainWindowViewModel"
            Title="TinyDb 专业管理工具"
            Icon="/Assets/avalonia-logo.ico">

    <suki:SukiWindow.Hosts>
        <suki:SukiDialogHost />
        <suki:SukiToastHost />
    </suki:SukiWindow.Hosts>

    <Grid RowDefinitions="Auto, *">
        <!-- 顶部工具栏 -->
        <suki:GlassCard Grid.Row="0" Margin="10,10,10,5" Padding="10">
            <Grid ColumnDefinitions="Auto, *, Auto, Auto, Auto">
                <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center" Margin="0,0,20,0">
                    <material:MaterialIcon Kind="Database" Width="24" Height="24" Foreground="{DynamicResource SukiPrimaryColor}" Margin="0,0,10,0"/>
                    <TextBlock Text="TinyDb Manager" FontWeight="Bold" FontSize="18" VerticalAlignment="Center"/>
                </StackPanel>
                
                <TextBox Grid.Column="1" Text="{Binding DatabasePath}" Watermark="数据库文件路径..." IsEnabled="{Binding !IsConnected}"/>
                
                <Button Grid.Column="2" Classes="Flat" Command="{Binding SelectDatabaseFileCommand}" IsEnabled="{Binding !IsConnected}" Margin="5,0">浏览</Button>
                <Button Grid.Column="3" Classes="Accent" Command="{Binding ConnectCommand}" IsEnabled="{Binding CanConnect}">连接</Button>
                <Button Grid.Column="4" Classes="Basic" Command="{Binding DisconnectCommand}" IsEnabled="{Binding CanDisconnect}" Margin="5,0">断开</Button>
                <Button Grid.Column="5" Classes="Basic" Command="{Binding RecreateDatabaseCommand}" IsVisible="{Binding !IsConnected}">重置</Button>
            </Grid>
        </suki:GlassCard>

        <Grid Grid.Row="1" ColumnDefinitions="240, * " Margin="10,5,10,10">
            <!-- 左侧导航 -->
            <suki:GlassCard Grid.Column="0" Margin="0,0,5,0">
                <Grid RowDefinitions="Auto, *">
                    <Button Grid.Row="0" Classes="Flat" Command="{Binding OpenDesignWindowCommand}" HorizontalAlignment="Stretch" Margin="0,0,0,10">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <material:MaterialIcon Kind="TablePlus"/>
                            <TextBlock Text="设计新表"/>
                        </StackPanel>
                    </Button>
                    
                    <ListBox Grid.Row="1" ItemsSource="{Binding Collections}" SelectedItem="{Binding SelectedCollection}" Background="Transparent">
                        <ListBox.ItemTemplate>
                            <DataTemplate DataType="models:CollectionInfo">
                                <StackPanel Orientation="Horizontal" Spacing="10" Margin="5">
                                    <material:MaterialIcon Kind="Table" Width="16" Opacity="0.6"/>
                                    <TextBlock Text="{Binding Name}" VerticalAlignment="Center"/>
                                </StackPanel>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
                </Grid>
            </suki:GlassCard>

            <!-- 主内容 (多标签页) -->
            <suki:GlassCard Grid.Column="1" Margin="5,0,0,0" Padding="0">
                <TabControl ItemsSource="{Binding OpenTabs}" SelectedItem="{Binding SelectedTab}" Name="MainTabControl">
                    <TabControl.ItemTemplate>
                        <DataTemplate DataType="vm:TableTabViewModel">
                            <StackPanel Orientation="Horizontal" Spacing="10">
                                <TextBlock Text="{Binding TableName}" VerticalAlignment="Center"/>
                                <Button Classes="Flat" Command="{Binding $parent[Window].((vm:MainWindowViewModel)DataContext).CloseTabCommand}" 
                                        CommandParameter="{Binding}" Padding="2" BorderThickness="0">
                                    <material:MaterialIcon Kind="Close" Width="12"/>
                                </Button>
                            </StackPanel>
                        </DataTemplate>
                    </TabControl.ItemTemplate>
                    <TabControl.ContentTemplate>
                        <DataTemplate DataType="vm:TableTabViewModel">
                            <Grid RowDefinitions="Auto, *">
                                <!-- 表操作工具栏 -->
                                <Border Grid.Row="0" BorderBrush="{DynamicResource SukiBorderBrush}" BorderThickness="0,0,0,1" Padding="10">
                                    <StackPanel Orientation="Horizontal" Spacing="10">
                                        <Button Classes="Flat" Command="{Binding LoadDataCommand}">刷新</Button>
                                        <Button Classes="Flat" Command="{Binding AddRowCommand}">添加行</Button>
                                        <Button Classes="Flat" Command="{Binding DeleteRowCommand}" IsEnabled="{Binding SelectedRow, Converter={x:Static ObjectConverters.IsNotNull}}">删除行</Button>
                                        <Separator Classes="Vertical" Height="20"/>
                                        <Button Classes="Accent" Command="{Binding SaveChangesCommand}">应用更改</Button>
                                        <TextBlock Text="{Binding StatusMessage}" VerticalAlignment="Center" Margin="20,0" FontSize="12" Opacity="0.6"/>
                                    </StackPanel>
                                </Border>
                                
                                <!-- 自定义稳定表格 -->
                                <ScrollViewer Grid.Row="1" HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Auto">
                                    <StackPanel>
                                        <!-- 动态表头 -->
                                        <Border Background="{DynamicResource SukiBackground}" BorderBrush="{DynamicResource SukiBorderBrush}" BorderThickness="0,0,0,1">
                                            <ItemsControl ItemsSource="{Binding Fields}">
                                                <ItemsControl.ItemsPanel>
                                                    <ItemsPanelTemplate>
                                                        <StackPanel Orientation="Horizontal"/>
                                                    </ItemsPanelTemplate>
                                                </ItemsControl.ItemsPanel>
                                                <ItemsControl.ItemTemplate>
                                                    <DataTemplate>
                                                        <Border Width="150" Padding="10,12" BorderBrush="{DynamicResource SukiBorderBrush}" BorderThickness="0,0,1,0">
                                                            <TextBlock Text="{Binding FieldName}" FontWeight="Bold" Opacity="0.7"/>
                                                        </Border>
                                                    </DataTemplate>
                                                </ItemsControl.ItemTemplate>
                                            </ItemsControl>
                                        </Border>

                                        <!-- 数据行 -->
                                        <ListBox ItemsSource="{Binding Rows}" SelectedItem="{Binding SelectedRow}" Background="Transparent" Padding="0">
                                            <ListBox.ItemTemplate>
                                                <DataTemplate DataType="vm:RowViewModel">
                                                    <ItemsControl ItemsSource="{Binding Cells}">
                                                        <ItemsControl.ItemsPanel>
                                                            <ItemsPanelTemplate>
                                                                <StackPanel Orientation="Horizontal"/>
                                                            </ItemsPanelTemplate>
                                                        </ItemsControl.ItemsPanel>
                                                        <ItemsControl.ItemTemplate>
                                                            <DataTemplate DataType="vm:CellViewModel">
                                                                <Border Width="150" Height="40" BorderBrush="{DynamicResource SukiBorderBrush}" BorderThickness="0,0,1,1">
                                                                    <TextBox Text="{Binding Value, Mode=TwoWay}" 
                                                                             BorderThickness="0" 
                                                                             Background="Transparent" 
                                                                             VerticalAlignment="Stretch" 
                                                                             VerticalContentAlignment="Center"
                                                                             Padding="8,0"
                                                                             FontSize="13"/>
                                                                </Border>
                                                            </DataTemplate>
                                                        </ItemsControl.ItemTemplate>
                                                    </ItemsControl>
                                                </DataTemplate>
                                            </ListBox.ItemTemplate>
                                        </ListBox>
                                    </StackPanel>
                                </ScrollViewer>
                                
                                <suki:Loading IsVisible="{Binding IsLoading}" HorizontalAlignment="Center" VerticalAlignment="Center" Width="40" Height="40"/>
                            </Grid>
                        </DataTemplate>
                    </TabControl.ContentTemplate>
                </TabControl>
            </suki:GlassCard>
        </Grid>

        <!-- 状态栏 -->
        <Border Grid.Row="1" VerticalAlignment="Bottom" HorizontalAlignment="Stretch" Height="32" Background="{DynamicResource SukiBackground}" BorderThickness="0,1,0,0" BorderBrush="{DynamicResource SukiBorderBrush}" Margin="10,0,10,0">
            <Grid ColumnDefinitions="*, Auto" Margin="15,0">
                <TextBlock Text="{Binding StatusMessage}" VerticalAlignment="Center" FontSize="11" Opacity="0.7"/>
                <StackPanel Grid.Column="1" Orientation="Horizontal" VerticalAlignment="Center" Spacing="20">
                    <TextBlock Text="{Binding OpenTabs.Count, StringFormat='{}标签页: {0}'}" FontSize="11" Opacity="0.5"/>
                    <suki:Loading IsVisible="{Binding IsLoading}" Width="16" Height="16"/>
                </StackPanel>
            </Grid>
        </Border>
    </Grid>
</suki:SukiWindow>
